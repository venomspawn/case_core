# Статусная модель заявки на неавтоматизированную услугу

Модель заявки на неавтоматизированную услугу поддерживает следующие статусы.

*  `packaging` (формирование пакета документов);
*  `pending` (ожидание отправки в ведомство);
*  `processing` (обработка заявки в ведомстве);
*  `issuance` (выдача результата заявки);
*  `rejecting` (возврат результата заявки в ведомство);
*  `closed` (заявка закрыта).

Статус заявки `packaging` является изначальным и устанавливается обработчиком
`on_case_creation` непосредственно после создания записи заявки.

# Жизненный цикл заявки на неавтоматизированную услугу

Жизненный цикл заявки можно описать следующим графом переходов, где вершины
графа — это названия статуса, приведённые выше, или его отсутствие (сразу
после создания записи заявки), а метки дуг — это вызовы функций модуля с учётом
условий на атрибуты.

```
            +-+   A   +-----------+
            | |------>| packaging |
            +-+       +-----------+
                         ^     |
                      C1 |     | B
                         |     V
                       +---------+
    +------------------| pending |------------+
    |       +--------->|         |            |
    |       |          +---------+            |
    |       |               |                 |
    |       |               | D1              |
    |       |               V                 |
    |       |        +------------+           |
    | C2    | B      | processing |           | D2
    |       |        +------------+           |
    |       |               |                 |
    |       |               | E               |
    v       |               V                 V
  +-----------+   G   +----------+   F   +--------+
  | rejecting |<------| issuance |------>| closed |
  +-----------+       +----------+       +--------+
```

Метки дуг обозначают следующее:

*   `A` — вызов функции `on_case_creation` для записи заявки;
*   `B` — вызов функции `add_to_pending_list` для записи заявки;
*   `C1` — вызов функции `remove_from_pending_list` для записи заявки при
    условии, что атрибут `added_to_rejecting_at` заявки отсутствует или его
    значение пусто;
*   `C2` — вызов функции `remove_from_pending_list` для записи заявки при
    условии, что атрибут `added_to_rejecting_at` заявки присутствует и его
    значение непусто;
*   `D1` — вызов функции `export_register` для записи реестра передаваемой
    корреспонденции, ассоциированной с записью заявки, при одновременном
    выполнении следующих условиях:
    -   атрибут `issue_location_type` отсутствует или его значение не равно
        `institution`;
    -   атрибут `added_to_rejecting_at` отсутствует или его значение пусто;
*   `D2` — вызов функции `export_register` для записи реестра передаваемой
    корреспонденции, ассоциированной с записью заявки, если выполняется хотя бы
    одно из следующих условий:
    -   атрибут `issue_location_type` присутствует и его значение равно
        `institution`;
    -   атрибут `added_to_rejecting_at` присутствует и его значение непусто;
*   `E` — вызов функции `send_to_frontoffice` для записи заявки;
*   `F` — вызов функции `issue` при условии, что атрибут
    `rejecting_expected_at` присутствует, его значение начинается с даты,
    записанной в формате ISO 8601, и эта дата строго меньше текущей даты;
*   `G` — вызов функции `reject_result` для записи заявки при условии, что
    атрибут `rejecting_expected_at` присутствует, его значение начинается с
    даты, записанной в формате ISO 8601, и эта дата больше текущей даты или
    равна ей.
