# Статусная модель заявки на МСП-услугу

Модель заявки на МСП-услугу поддерживает следующие статусы.

*  `processing` (обработка заявки);
*  `issuance` (выдача результата заявки);
*  `error` (при обработке заявки произошла ошибка);
*  `closed` (заявка закрыта).

Статус заявки `processing` является изначальным и устанавливается обработчиком
`on_case_creation` непосредственно после создания записи заявки.

# Жизненный цикл заявки на МСП-услугу

Жизненный цикл заявки можно описать следующим графом переходов, где вершины
графа — это названия статуса, приведённые выше, или его отсутствие (сразу
после создания записи заявки), а метки дуг — это вызовы функций модуля с учётом
условий на атрибуты.

```
   +-+   A   +------------+   B1  +-------+
   | |------>| processing |------>| error |
   +-+       +------------+       +-------+
                |      |
                | B2   | B3
                |      V
                |   +----------+
                |   | issuance |
                |   +----------+
                |      |
                |      | C
                V      V
               +--------+
               | closed |
               +--------+
```

Метки дуг обозначают следующее:

*   `A` — вызов функции `on_case_creation` для записи заявки;
*   `B1` — вызов функции `on_responding_stomp_message` для сообщения STOMP,
    удовлетворяющего следующим условиям:
    -   тело сообщения представляет собой JSON-представление ассоциативного
        массива (требования к структуре ассоциативного массива описаны в виде
        JSON-схемы в коде обработчика);
    -   по значению поля `id` этого ассоциативного массива можно восстановить
        запись с данными запроса, а также запись заявки на МСП-услугу;
    -   значение поля `format` этого ассоциативного массива равно `EXCEPTION`;
*   `B2` — вызов функции `on_responding_stomp_message` для сообщения STOMP,
    удовлетворяющего следующим условиям:
    -   тело сообщения представляет собой JSON-представление ассоциативного
        массива (требования к структуре ассоциативного массива описаны в виде
        JSON-схемы в коде обработчика);
    -   по значению поля `id` этого ассоциативного массива можно восстановить
        запись с данными запроса, а также запись заявки на МСП-услугу;
    -   значение поля `format` этого ассоциативного массива равно `REJECTION`
        или `RESPONSE`;
    -   атрибут `issue_location_type` заявки присутствует и его значение равно
        `email`;
*   `B3` — вызов функции `on_responding_stomp_message` для сообщения STOMP,
    удовлетворяющего следующим условиям:
    -   тело сообщения представляет собой JSON-представление ассоциативного
        массива (требования к структуре ассоциативного массива описаны в виде
        JSON-схемы в коде обработчика);
    -   по значению поля `id` этого ассоциативного массива можно восстановить
        запись с данными запроса, а также запись заявки на МСП-услугу;
    -   значение поля `format` этого ассоциативного массива равно `REJECTION`
        или `RESPONSE`;
    -   атрибут `issue_location_type` заявки присутствует и его значение равно
        `mfc`;
*   `C` — вызов функции `issue` для записи заявки.
