# Сервис, предоставляющий API для управления заявками

Приложение предоставляет REST API и STOMP API для управления записями заявок и
ассоциированных с ними записями документов и межведомственными запросов, а
также для получения информации об этих сущностях.

## Вызов отладочной консоли и тестов

Для вызова отладочной консоли и тестов рекомендуется использовать виртуальную
машину, которую можно запустить с помощью команды `vagrant up` в терминале
(здесь и далее подразумевается, что текущий путь терминала указывает на
корневую директорию Git-репозитория приложения). После создания, запуска и
настройки виртуальной машины необходимо зайти в неё с помощью команды
`vagrant ssh`. Следующие команды выполняются в терминале виртуальной машины:

*   `make install` — установка необходимых библиотек после создания виртуальной
    машины;
*   `make migrate` — создание необходимых таблиц в базе данных;
*   `make debug` — запуск отладочной IRB-консоли;
*   `make test` — запуск тестов;
*   `make run` — запуск приложения.

## Настройка

Приложение поддерживает настройку с помощью переменных окружения.

### Настройки журнала событий

*   `CC_LOG_LEVEL` — режим отображения событий. Поддерживаются следующие
    значения:
    -   `debug` — отображение всех сообщений, в том числе отладочных (режим по
        умолчанию);
    -   `info` — отображение информационных сообщений и сообщений об ошибках;
    -   `error` — отображение только сообщений об ошибках;
    -   `unknown` — отключение отображения событий.

### Настройки подключения к базе данных

*   `CC_DB_USER` — название пользователя базы данных.
*   `CC_DB_PASS` — пароль для подключения к базе данных.
*   `CC_DB_HOST` — адрес сервера базы данных.
*   `CC_DB_NAME` — название базы данных.

### Настройки REST-контроллера

*   `CC_BIND` — адрес входящих подключений.
*   `CC_PORT` — порт входящих подключений.

### Настройки STOMP-контроллера

*   `CC_STOMP_HOST` — адрес сервера ActiveMQ.
*   `CC_STOMP_PORT` — порт сервера ActiveMQ (по умолчанию принимает значение
    `61613`).
*   `CC_STOMP_INCOMING_QUEUE` — название очереди сообщений, управляющих
    сущностями (по умолчанию принимает значение `case_core.incoming.queue`).
*   `CC_STOMP_RESPONSE_QUEUE` — название очереди ответных сообщений СМЭВ (по
    умолчанию принимает значение `case_core.response.queue`).

### Настройки извлечения библиотек с бизнес-логикой

*   `CC_GEM_SERVER_HOST` — адрес сервера с библиотеками (по умолчанию принимает
    значение `10.33.68.123`).
*   `CC_GEM_SERVER_PORT` — порт сервера с библиотеками (по умолчанию принимает
    значение `9292`).

## Миграция базы данных

Следующие команды управляют миграциями базы данных.

*   `make migrate` — миграция базы данных на последнюю версию схемы базы
    данных. Повторное выполнение команды не приводит к миграции.

*   `bundle exec rake case_core:migrate[0]` — миграция базы данных, приводящая
    к удалению всех таблиц, индексов и типов, необходимых для выполнения
    приложения.

## Документация

### Документация исходного кода

Исходный код прокомментирован с помощью [`yard`](https://yardoc.org), что
позволяет создать документацию в HTML-формате. Для этого необходимо выполнить
команду `make doc` в терминале виртуальной машины. Документация будет создана в
директории `doc`.

### Дополнительная документация

С приложением поставляется следующая документация по отдельным аспектам его
функционала:

*   [модели и записи](./docs/MODELS.md);
*   [действия над записями](./docs/ACTIONS.md);
*   [механизм поиска записей заявок и межведомственных
    запросов](./docs/SEARCH.md);
*   [установка и загрузка бизнес-логики](./docs/LOGIC_LOAD.md);
*   [события бизнес-логики](./docs/LOGIC_EVENT.md);
*   [REST API](./docs/RESTAPI.md);
*   [STOMP API](./docs/STOMPAPI.md).
*   [разработка модуля бизнес-логики: рекомендации и
    указания](./docs/LOGIC_DEVELOPMENT.md);
