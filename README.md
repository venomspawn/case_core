# Сервис, предоставляющий API для управления заявками

Приложение предоставляет REST API и STOMP API для управления записями заявок и
ассоциированных с ними записями документов и межведомственными запросов, а
также для получения информации об этих сущностях.

## Вызов отладочной консоли и тестов

Для вызова отладочной консоли и тестов рекомендуется использовать виртуальную
машину, которую можно запустить с помощью команды `vagrant up` в терминале
(здесь и далее подразумевается, что текущий путь терминала указывает на
корневую директорию Git-репозитория приложения). После создания, запуска и
настройки виртуальной машины необходимо зайти в неё с помощью команды
`vagrant ssh`. Следующие команды выполняются в терминале виртуальной машины:

*   `make install` — установка необходимых библиотек после создания виртуальной
    машины;
*   `make migrate` — создание необходимых таблиц в базе данных;
*   `make debug` — запуск отладочной IRB-консоли;
*   `make test` — запуск тестов;
*   `make run` — запуск приложения.

## Настройка

Приложение поддерживает настройку с помощью переменных окружения.

### Настройки журнала событий

*   `CC_LOG_LEVEL` — режим отображения событий. Поддерживаются следующие
    значения:
    -   `debug` — отображение всех сообщений, в том числе отладочных (режим по
        умолчанию);
    -   `info` — отображение информационных сообщений и сообщений об ошибках;
    -   `error` — отображение только сообщений об ошибках;
    -   `unknown` — отключение отображения событий.

### Настройки подключения к базе данных

*   `CC_DB_HOST` — адрес сервера базы данных.
*   `CC_DB_NAME` — название базы данных.
*   `CC_DB_USER` — название пользователя базы данных.
*   `CC_DB_PASS` — пароль для подключения к базе данных.

### Настройки REST-контроллера

*   `CC_BIND` — адрес входящих подключений.
*   `CC_PORT` — порт входящих подключений.
*   `CC_PUMA_WORKERS` — количество дочерних процессов обработки запросов (по
    умолчанию принимает значение 4).
*   `CC_PUMA_THREADS_MIN` — минимальное количество потоков обработки запросов
    (по умолчанию принимает значение 0).
*   `CC_PUMA_THREADS_MAX` — максимальное количество потоков обработки запросов
    (по умолчанию принимает значение 8).

### Настройки STOMP-контроллера

*   `CC_STOMP_HOST` — адрес сервера ActiveMQ.
*   `CC_STOMP_PORT` — порт сервера ActiveMQ (по умолчанию принимает значение
    `61613`).
*   `CC_STOMP_INCOMING_QUEUE` — название очереди сообщений, управляющих
    сущностями (по умолчанию принимает значение `case_core.incoming.queue`).
*   `CC_STOMP_INCOMING_LISTENERS` — количество слушателей очереди сообщений,
    управляющих сущностями (по умолчанию принимает значение `1`).
*   `CC_STOMP_RESPONSE_QUEUE` — название очереди ответных сообщений СМЭВ (по
    умолчанию принимает значение `case_core.response.queue`).
*   `CC_STOMP_RESPONSE_LISTENERS` — количество слушателей очереди ответных
    сообщений СМЭВ (по умолчанию принимает значение `1`).

### Настройки извлечения библиотек с бизнес-логикой

*   `CC_GEM_SERVER_HOST` — адрес сервера с библиотеками (по умолчанию принимает
    значение `10.33.68.123`).
*   `CC_GEM_SERVER_PORT` — порт сервера с библиотеками (по умолчанию принимает
    значение `9292`).
*   `CC_GEM_SERVER_PATH` — путь к библиотекам на сервере с библиотеками (по
    умолчанию принимает значение ``).
*   `CC_LOGIC_DIR` — путь к директории с библиотеками с бизнес-логики
    относительно директории с проектом.

### Настройки подключения к Consul

*   `CC_CONSUL_SCHEMA` — тип подключения к Consul (по умолчанию принимает
    значение `http`).
*   `CC_CONSUL_HOST` — адрес сервера Consul (по умолчанию принимает значение
    `10.33.68.225`).
*   `CC_CONSUL_PORT` — порт сервера Consul (по умолчанию принимает значение
    `8500`).

### Настройки подключения к файловому хранилищу

*   `CC_FS_HOST` — адрес сервера файлового хранилища.
*   `CC_FS_PORT` — порт сервера файлового хранилища.

### Настройки подключения к базам данных сервисов для переноса данных

*   `CC_CAB_HOST` — адрес сервера базы данных личного кабинета заявителя.
*   `CC_CAB_NAME` — название базы данных личного кабинета заявителя.
*   `CC_CAB_USER` — название пользователя базы данных личного кабинета
    заявителя.
*   `CC_CAB_PASS` — пароль для подключения к базе данных личного кабинета
    заявителя.
*   `CC_CM_HOST` — адрес сервера базы данных заявок.
*   `CC_CM_NAME` — название базы данных заявок.
*   `CC_CM_USER` — название пользователя базы данных заявок.
*   `CC_CM_PASS` — пароль для подключения к базе данных заявок.
*   `CC_MFC_HOST` — адрес сервера базы данных основного приложения АИС «Мои
    документы».
*   `CC_MFC_NAME` — название базы данных основного приложения АИС «Мои
    документы».
*   `CC_MFC_USER` — название пользователя базы данныхосновного приложения АИС
    «Мои документы».
*   `CC_MFC_PASS` — пароль для подключения к базе данных основного приложения
    АИС «Мои документы».
*   `CC_OS_HOST` — адрес сервера базы данных организационной структуры.
*   `CC_OS_NAME` — название базы данных организационной структуры.
*   `CC_OS_USER` — название пользователя базы данных организационной структуры.
*   `CC_OS_PASS` — пароль для подключения к базе данных организационной
    структуры.

## Настройка периода автоматического обновления библиотек

*   `CC_FETCHER_CRON` — cron-строка с периодом обновления (см. также описание
    ниже в секции «Загрузка бизнес-логики»)

## Миграция базы данных

Следующие команды управляют миграциями базы данных.

*   `make migrate` — миграция базы данных на последнюю версию схемы базы
    данных. Повторное выполнение команды не приводит к миграции.

*   `bundle exec rake case_core:migrate[0]` — миграция базы данных, приводящая
    к удалению всех таблиц, индексов и типов, необходимых для выполнения
    приложения.

## Загрузка бизнес-логики

Приложение поддерживает динамическую подгрузку библиотек с бизнес-логикой из
директории `logic`. Для того, чтобы загрузить и распаковать библиотеку с
бизнес-логикой из хранилища библиотек в директорию `logic`, можно выполнить
следующую команду:

```
bundle exec rake case_core:fetch_logic[<name>, <version>]
```

Здесь `<name>` — название библиотеки (например, `mfc_case`), а `<version>` — её
версия. Можно использовать следующий формат команды:

```
bundle exec rake case_core:fetch_logic[<name>]
```

В таком случае загрузится последняя версия библиотеки. Если в директории
`logic` окажется библиотека более новой версии, нежели подгруженная в
приложение, то подгруженный код будет выгружен из памяти приложения, а новый —
загружен.

Дополнительно приложение предоставляет сервис автоматической загрузки и
распаковки последней версии библиотек с сервера библиотек. Этот сервис
обновляет библиотеки и закачивает отсутствующие при запуске сервиса, а также
периодически со временем ожидания, заданном значением переменной окружения
`CC_FETCHER_CRON`. Если значение переменной окружения `CC_FETCHER_CRON` не
задано или не представляет собой корректную cron-строку, то сервис загружает и
обновляет библиотеки только при запуске. Сервис проверяет версии только тех
библиотек, чьё название заканчивается на строку `_case` (например, `mfc_case`
или `certificate_case`).

## Дополнительные команды

*   `bundle exec rake case_core:run_rest_controller` — запуск только
    REST-контроллера.

*   `bundle exec rake case_core:run_stomp_controller` — запуск только
    STOMP-контроллера.

*   `bundle exec rake case_core:run_fetcher` — запуск только сервиса
    автоматического обновления библиотек.

*   `bundle exec rake case_core:transfer` — перенос данных из предыдущих
    сервисов.

## Документация

### Документация исходного кода

Исходный код прокомментирован с помощью [`yard`](https://yardoc.org), что
позволяет создать документацию в HTML-формате. Для этого необходимо выполнить
команду `make doc` в терминале виртуальной машины. Документация будет создана в
директории `doc`.

### Дополнительная документация

С приложением поставляется следующая документация по отдельным аспектам его
функционала:

*   [модели и записи](./docs/MODELS.md);
*   [действия над записями](./docs/ACTIONS.md);
*   [механизм поиска записей заявок и межведомственных
    запросов](./docs/SEARCH.md);
*   [установка и загрузка бизнес-логики](./docs/LOGIC_LOAD.md);
*   [события бизнес-логики](./docs/LOGIC_EVENT.md);
*   [REST API](./docs/RESTAPI.md);
*   [STOMP API](./docs/STOMPAPI.md).
*   [разработка модуля бизнес-логики: рекомендации и
    указания](./docs/LOGIC_DEVELOPMENT.md);
