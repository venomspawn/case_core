# Механизм поиска записей заявок и межведомственных запросов

Для поиска записей заявок и межведомственных запросов с учётом условий на
значения полей и атрибутов приложение предоставляет специальный механизм,
оформленный в виде класса `CaseCore::Search::Query` и запускаемый с помощью
функции `dataset` этого класса.

## Возможности механизма

*   Поддерживает любые модели, с которыми связаны модели атрибутов
    (в приложении таких две: модель заявки и модель межведомственного запроса).

*   Поддерживает фильтрацию заявок с помощью условий на значения полей и
    атрибутов. В условия входят
    -   совпадение с заданным значением или с одним из значений списка;
    -   совпадение по шаблону;
    -   минимум и максимум значений.
    Кроме того, условия можно соединять конъюнкцией и дизъюнкцией, также
    поддерживается отрицание условия.

*   Поддерживает сортировку по возрастанию и убыванию значений полей
    (сортировка по значениям атрибутов не поддерживается).

*   Поддерживает страничный поиск с учётом количества заявок на странице и
    смещения. При этом, если не указана сортировка по полям, записи сортируются
    по возрастанию значений первичного ключа.

## Использование механизма

Механизм используют действия извлечения списка заявок и межведомственных
запросов, а также действие подсчёта количества заявок. Параметры указанных
действий совпадают с параметрами механизма за исключением того, что действия
извлечения списка записей дополнительно позволяют указывать список названий
извлекаемых полей, а действие подсчёта количества заявок не поддерживает
указание сортировки полей.

## Параметры механизма

Функция `dataset` класса `CaseCore::Search::Query` и приведённые выше действия
требуют указывать параметры механизма в виде ассоциативного массива параметров,
в котором ключи являются названиями параметров, а значения — значениями
параметров. Механизм может использовать следующие параметры.

*   `filter` — позволяет указывать условия на значения полей и атрибутов.
    Значением параметра может быть либо ассоциативный массив, либо список
    ассоциативных массивов. Ключи ассоциативного массива, являющегося значением
    параметра или элементом списка, интерпретируются в качестве названий полей
    и атрибутов, а их значения — в качестве условий на эти поля или атрибуты.
    Набор условий, заданных одним ассоциативным массивом, механизм связывает
    конъюнкцией, а результирующие условия, заданные элементами списка,
    дизъюнкцией. Вывод условий из значений ассоциативного массива происходит
    следующим образом.
    -   Если значение не является ни списком, ни ассоциативным массивом, то
        условием считается равенство значения значению поля или атрибута.
    -   Если значение является списком, то условием считается равенство
        значения поля или атрибута одному из элементов списка.
    -   Если значение является ассоциативным массивом, то условие выводится из
        его ключей. Несколько ключей может быть указано одновременно, при этом
        результирующим условием будет конъюнкция условий, выведенных из ключей.
        Поддерживаются следующие ключи.
        +   `exclude` — задаёт отрицание. Значение по данному ключу должно
            иметь структуру условия (то есть отвечать одному из трёх пунктов
            выше).
        +   `like` — задаёт сравнение по шаблону. Значение по данному ключу
            должно быть строкой с шаблоном.
        +   `min` — задаёт нижнюю границу значений. Значение по данному ключу
            должно быть строкой.
        +   `max` — задаёт верхнюю границу значений. Значение по данному ключу
            должно быть строкой.
        Механизм игнорирует неподдерживаемые ключи, а действия запрещают их.
        Кроме того, действия запрещают ассоциативному массиву не иметь ни
        одного поддерживаемого ключа (механизм в таком случае выбирает все
        записи).

    В случае, когда параметр не указан или значение параметра является пустым
    ассоциативным массивом или пустым списком, механизм извлекает все записи.

*   `limit` — задаёт максимальное количество извлекаемых записей. Значение
    параметра должно быть натуральным числом. Если параметр не указан, то
    механизм извлекает все записи.

*   `offset` — задаёт сдвиг в выборке записей. Значение параметра должно быть
    целым неотрицательным числом. Если параметр не указан, то механизм считает,
    что сдвиг в выборке отсутствует.

*   `order` — задаёт сортировку по полям записей. Значение параметра должно
    быть ассоциативным массивом, в котором ключи интерпретируются в качестве
    названий полей, а значения могут быть равны только двум строкам: `asc`
    (сортировка по возрастанию значений) и `desc` (сортировка по убыванию
    значений). Ассоциативный массив должен содержать хотя бы один ключ и может
    содержать несколько ключей, в таком случае сортировка происходит согласно
    порядку ключей в ассоциативном массиве. Если параметр не указан, то в
    случае отсутствия параметров `limit` и `offset` сортировка отсутствует, а в
    случае наличия хотя бы одного из параметров `limit` и `offset` сортировка
    происходит по значениям первичного ключа записей.  Параметр не
    поддерживается действием подсчёта записей.

*   `fields` — задаёт названия извлекаемых полей и атрибутов. Значение
    параметра должно быть строкой или списком строк. Если параметр не указан,
    то извлекаются все поля и атрибуты. Если значение параметра указано, то при
    обработке из него формируется список, в котором присутствует первичный
    ключ. Параметр поддерживается только лишь действиями извлечения записей.

## Примеры применения механизма

1.  Пусть `filter = { state: { exclude: 'ok' } }`, тогда при использовании
    механизма для поиска записей заявок будут извлечены все записи заявок, у
    которых атрибут `state` не равен `ok`.

2.  Пусть `filter = { state: 'ok', created_at: { max: '2018-02-22 12:34'} }`,
    тогда при использовании механизма для поиска записей заявок будут извлечены
    все записи заявок, у которых атрибут `state` равен `ok`, а значение поля
    `created_at` (дата и время создания записи) меньше или равно дате и времени
    22 февраля 2018 года 12:34.

3.  Пусть `filter = [{ state: 'ok'}, { created_at: '2018-02-22 12:34' }]`,
    тогда при использовании механизма для поиска записей заявок будут извлечены
    все записи заявок, у которых атрибут `state` равен `ok` или значение поля
    `created_at` равно дате и времени 22 февраля 2018 года 12:34.

4.  Пусть `limit = 20`, `offset = 20`, тогда при использовании механизма для
    поиска записей заявок будут извлечено не более 20 записей заявок, сдвинутых
    в списке записей, который отсортирован по возрастанию значений первичного
    ключа записей, на 20 позиций.

5.  Пусть `filter = { state: 'ok' }`, `limit = 20`, `offset = 20`,
    `order = { created_at: 'desc' }`, тогда при использовании механизма для
    поиска записей заявок будут извлечено не более 20 записей заявок, у которых
    значение атрибута `state` равно `ok`, сдвинутых в списке записей, который
    отсортирован по убыванию значений поля `created_at`.

6.  Пусть `filter = { state: 'ok' }`, `fields = ['state']`, тогда при
    использовании механизма для поиска записей заявок будут извлечены все
    записи заявок, у которых атрибут `state` равен `ok`, при этом будут
    возвращены только значения поля `id` и атрибута `state`.
