# Установка и загрузка бизнес-логики

Архитектура приложения подразумевает, что бизнес-логика не поставляется вместе
с ним, а устанавливается и загружается с помощью специальных механизмов
приложения. При этом предполагается, что бизнес-логика поставляется в виде
Ruby-библиотек («гемов») и располагается на удалёном сервере, поддерживающим
стандартный протокол загрузки библиотек.

## Установка бизнес-логики

Приложение обладает следующими механизмами для установки бизнес-логики.

### Класс `CaseCore::Logic::Fetcher`

Класс `CaseCore::Logic::Fetcher` предоставляет функцию `fetch`, которая для
заданного имени библиотеки выполняет следующие действия:

* загружает с сервера библиотек информацию о версиях библиотеки и выбирает
  среди них самую последнюю, если не указана требуемая версия библиотеки;
* загружает с сервера библиотек файл с библиотекой выбранной версии;
* создаёт в директории, заданную настройками класса `CaseCore::Logic::Loader`,
  новую директорию с названием `<NAME>-<VERSION>`, где `<NAME>` — название
  библиотеки, а `<VERSION>` — её версия;
* извлекает содержимое библиотеки (кроме директорий `spec` и `test`) в
  созданную директорию.

Если при вызове функции `fetch` происходит ошибка, то информация о ней
выводится в стандартный поток вывода.

Класс `CaseCore::Logic::Fetcher` обладает следующими настройками, которые можно
установить с помощью функции класса `configure`:

* `gem_server_host` (адрес сервера библиотек);
* `gem_server_port` (порт сервера библиотек).

### Rake-задача `case_core:fetch_logic`

Rake-задача `case_core:fetch_logic` предоставляет доступ к функции `fetch`
класса `CaseCore::Logic::Fetcher` из командной строки. Примеры использования:

* `bundle exec rake case_core:fetch_logic[mfc_case]` — загрузка с сервера
  библиотек библиотеки `mfc_case` последней версии и её распаковка;
* `bundle exec rake case_core:fetch_logic[mfc_case,0.12.1]` — загрузка с
  сервера библиотек библиотеки `mfc_case` версии `0.12.1` и её распаковка.

## Загрузка бизнес-логики в приложение

Для загрузки библиотеки бизнес-логики в приложение используется функция `logic`
класса `CaseCore::Logic::Loader`, которая принимает название библиотеки в
качестве аргумента. Функция выполняет следующие действия:

* при необходимости загружает последнюю версию библиотеки, выгрузив
  предыдующую, если она была загружена;
* ищет первый модуль из тех, что появились в пространстве имён `Object` после
  загрузки библиотеки, название которого совпадает с названием библиотеки, если
  удалить в нём все символы `_` и не учитывать регистр символов.
* если модуль найден, то возвращает его, иначе возвращает `nil`.

### Примеры

* Пусть при вызове `CaseCore::Logic::Loader.fetch('test_case')` загрузился
  модуль `TestCase`, тогда функция найдёт и вернёт его.

* Пусть при вызове `CaseCore::Logic::Loader.fetch('mixed_case')` загрузился
  модуль `MixedCASE`, тогда функция найдёт и вернёт его.

* Пусть при вызове `CaseCore::Logic::Loader.fetch('wrong_case')` загрузился
  модуль `WontBeFound`, тогда функция не найдёт его и вернёт `nil`.

Класс `CaseCore::Logic::Loader` обладает следующими настройками, которые можно
установить с помощью функции класса `configure`:

* `dir` — полный путь к директории с библиотеками бизнес-логики;
* `dir_check_period` — интервал в секундах, указывающий, как часто надо
  проверять директорию с библиотеками на наличие новых версий уже загруженных
  библиотек.

## Автоматическое сканирование на наличие новых версий

Поскольку необходимо, чтобы новые библиотеки бизнес-логики были немедленно
загружены, приложение предоставляет механизм автоматического сканирования
директории с библиотеками в виде класса `CaseCore::Logic::Scanner`. Функция
класса `run!` осуществляет следующие действия:

* запускает отдельный поток сканирования, если такой поток ещё не был запущен;
* поток сканирования с интервалом в заданное время проверяет директорию с
  библиотеками на появление новых библиотек;
* если новые библиотеки найдены, то они автоматически загружаются с помощью
  функции `fetch` класса `CaseCore::Logic::Loader`.

Класс `CaseCore::Logic::Scanner` обладает следующими настройками, которые можно
установить с помощью функции класса `configure`:

* `dir_check_period` — интервал в секундах, указывающий, как часто надо
  проверять директорию с библиотеками на наличие новых версий библиотек.
