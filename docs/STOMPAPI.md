# STOMP API

При запуске контроллера STOMP API с помощью вызова функции `run!` класса
`CaseCore::API::STOMP::Controller` осуществляются подписки на следующие
очереди:

*   очередь сообщений о том, что необходимо выполнить действие;

*   очередь ответных сообщений с адаптеров внешних контуров (СМЭВ 2, СМЭВ 3 и
    так далее).

Сообщения из этих очередей контроллер осуществляет различным образом.

## Обработка сообщений о том, что необходимо выполнить действие

1.   Обработка начинается с изучения заголовка `x_message_id`. Значение в этом
     заголовке интерпретируется в качестве идентификатора сообщения. При
     отсутствии этого заголовка обработка останавливается с созданием
     соответствующего исключения.

2.   Значение заголовка `x_entities` интерпретируется в качестве названия
     модуля пространства имён `CaseCore::Actions` (значение предварительно
     приводится к форме множественного числа и ВерблюжьемуРегистру). При
     отсутствии этого заголовка обработка останавливается с созданием
     соответствующего исключения.

     Примеры обработки значений заголовка `x_entities`:
     *   `cases` ~> название модуля `Cases`;
     *   `case` ~> название модуля `Cases`;
     *   `complicated_things` ~> название модуля `ComplicatedThings`;
     *   `BIGCASE` ~> название модуля `Bigcase`.

3.   Значение заголовка `x_action` интерпретируется в качестве названия функции
     модуля, найденного во время этапа 2 (значение предварительно приводится к
     змеиному_регистру). При отсутствии этого заголовка обработка
     останавливается с созданием соответствующего исключения.

     Примеры обработки значений заголовка `x_action`:
     *   `CREATE` ~> название функции `create`;
     *   `cReAtE_s0m3th1ng_WEIRD` ~> название функции `create_s0m3th1ng_weird`.

4.   Тело сообщения интерпретируется как JSON-строка. Если тело сообщения не
     является корректной JSON-строкой, то обработка останавливается с созданием
     соответствующего исключения.

5.   После обработки заголовков в модуле с названием, найденным во время
     этапа 2, вызывается функция с названием, найденным во время этапа 3, и
     аргументом, восстановленным из тела сообщения во время этапа 4.
     *   Если во время процесса обработки и вызова функции создаётся
         исключение, то соответствующая информация выводится в стандартный
         поток вывода, а также создаётся запись в таблице `processing_statuses`
         со значением поля `status`, равным `error`.
     *   Если исключение не возникает, то создаётся запись в таблице
         `processing_statuses` со значением поля `status`, равным `ok`.

     В обоих случаях в записи сохраняются заголовки сообщения вместе со
     значением заголовка `x_message_id` (или с `nil`, если это значение
     отсутствует).

## Очередь ответных сообщений

Обработка ответного STOMP-сообщения не подразумевает наличия каких-либо
специальных заголовков и полностью возлагается на бизнес-логику с помощью
вызова функции `on_responding_stomp_message` модулей бизнес-логики. Процесс
оповещения о STOMP-сообщении из очереди ответных сообщений описан в документе,
посвящённом событиям бизнес-логики.
