# Действия над записями

REST API и STOMP API не работают с моделями непосредственно, а используют
для работы с данными прослойку так называемых действий. Действия являются
объектами классов пространства имён `CaseCore::Actions`. Для ещё большего
упрощения работы с данными модули в пространстве имён `CaseCore::Actions`
предлагают высокоуровневые функции, которые создают действие и совершают его.

Конструктор действий предполагает, что при создании будет предоставлен
ассоциативный массив параметров. При вызове конструктора его аргумент проходит
проверку на соответствие требуемой структуре, которая задаётся в виде
JSON-схемы константой `PARAMS_SCHEMA`, определённой в пространстве имён класса
действия.

## Функции пространства имён `CaseCore::Actions::Cases`

* `call`:
  - вызывает метод модуля бизнес-логики с записью заявки в качестве аргумента;
  - поддерживает также дополнительные аргументы, если они предоставлены.

* `create`:
  - создаёт запись заявки с данными атрибутами и прикреплёнными документами;
  - создаёт значение поля `id` записи заявки с помощью генератора UUID, если
    соответствующий атрибут не был предоставлен в ассоциативном массиве
    параметров;
  - игнорирует значение атрибута `created_at`, вместо этого в поле `created_at`
    записывает текущие дату и время;
  - после создания заявки вызывает функцию `on_case_creation` модуля
    бизнес-логики, соответствующей типу заявки, с созданной записью заявки в
    качестве аргумента.

* `index`:
  - возвращает список ассоциативных массивов с информацией о заявках;
  - поддерживает фильтрацию заявок по значениям и диапазонам значений
    атрибутов;
  - поддерживает извлечение как всех атрибутов заявок, так и заданных;
  - поддерживает извлечение в страничном режиме с указанием смещения и
    количества заявок.

* `show`:
  - возвращает ассоциативный массив c информацией о заявке с заданным
    идентификатором записи.

* `update`:
  - осуществляет транзакцию над записями таблицы `case_attributes`, в которую
    входят следующие операции:

    * удаление тех записей, у которых значение поля `case_id` совпадает со
      значением параметра `id` и значения поля `name` совпадают с ключами
      ассоциативного массива параметров;
    * добавление записей, у которых значение поля `case_id` совпадает со
      значением параметра `id`, значения поля `name` совпадают с ключами
      ассоциативного массива параметров, а значения поля `value` — с
      соответствующими значениями;

  - создаёт исключение, если в ассоциативном массиве параметров встречаются
    ключи `type` и `created_at`.

## Функции пространства имён `CaseCore::Actions::Documents`

* `create`:
  - создаёт запись документа с данными атрибутами и прикрепляет её к записи
    заявки с данными идентификатором;
  - создаёт значение поля `id` записи документа с помощью генератора UUID, если
    соответствующий атрибут не был предоставлен в ассоциативном массиве
    параметров.

* `index`:
  - возвращает список ассоциативных массивов с информацией о документах,
    прикреплённых к заявке с данным идентификатором записи.

* `update`:
  - обновляет запись документа.

## Функции пространства имён `CaseCore::Actions::ProcessingStatuses`

* `show`:
  - возвращает ассоциативный массив с информацией о статусе обработки сообщения
    STOMP с данным значением заголовка `x_message_id`.

## Функции пространства имён `CaseCore::Actions::Registers`

* `index`:
  - возвращает список ассоциативных массивов с информацией о реестрах
    передаваемой корреспонденции и количествах заявок, находящихся в них;
  - поддерживает фильтрацию записей реестров передаваемой корреспонденции по
    значениям атрибутов.

* `show`:
  - возвращает ассоциативный массив с информацией о реестре передаваемой
    корреспонденции с данным идентификатором записи, о заявках, находящихся в
    нём, и о количестве этих заявок.

## Функции пространства имён `CaseCore::Actions::Requests`

* `create`:
  - создаёт запись межведомственного запроса, используя текущие время и дату в
    качестве значения поля `created_at` и значение параметра `case_id` в
    качестве значения поля `case_id`;
  - создаёт записи атрибутов межведомственного запроса, используя в качестве
    значений полей `name` и `value` все ключи и значения ассоциативного массива
    параметров, кроме ключей `id`, `case_id` и `created_at`.

* `index`:
  - возвращает список ассоциативных массивов с информацией о межведомственных
    запросах, созданных в рамках заявки с данным идентификатором записи.

* `show`:
  - возвращает ассоциативный массив c информацией о межведомственном запросе с
    заданным идентификатором записи.

* `update`:
  - осуществляет транзакцию над записями таблицы `request_attributes`, в
    которую входят следующие операции:

    * удаление тех записей, у которых значение поля `request_id` совпадает со
      значением параметра `id` и значения поля `name` совпадают с ключами
      ассоциативного массива параметров;
    * добавление записей, у которых значение поля `request_id` совпадает со
      значением параметра `id`, значения поля `name` совпадают с ключами
      ассоциативного массива параметров, а значения поля `value` — с
      соответствующими значениями;

  - создаёт исключение, если в ассоциативном массиве параметров встречаются
    ключи `case_id` и `created_at`.
