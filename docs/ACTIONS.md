# Действия над записями

REST API и STOMP API не работают с моделями непосредственно, а используют
для работы с данными прослойку так называемых действий. Действия являются
объектами классов пространства имён `CaseCore::Actions`. Для ещё большего
упрощения работы с данными модули в пространстве имён `CaseCore::Actions`
предлагают высокоуровневые функции, которые создают действие и совершают его.

Конструктор действий предполагает, что при создании будет предоставлен
ассоциативный массив параметров. При вызове конструктора его аргумент проходит
проверку на соответствие требуемой структуре, которая задаётся в виде
JSON-схемы константой `PARAMS_SCHEMA`, определённой в пространстве имён класса
действия.

## Функции пространства имён `CaseCore::Actions::Cases`

### `call`

*   Вызывает метод модуля бизнес-логики с записью заявки в качестве аргумента.
*   Поддерживает дополнительные аргументы, если они предоставлены.

### `create`

*   Создаёт запись заявки с предоставленными атрибутами и прикреплёнными
    документами.
*   Создаёт значение поля `id` записи заявки с помощью генератора UUID, если
    соответствующий атрибут не был предоставлен в ассоциативном массиве
    параметров.
*   Игнорирует значение атрибута `created_at`, вместо этого в поле `created_at`
    записывает текущие дату и время.
*   Вызывает после создания записи заявки функцию `on_case_creation` модуля
    бизнес-логики, соответствующей типу заявки, с созданной записью заявки в
    качестве аргумента.

### `index`

*   Возвращает список ассоциативных массивов с информацией о заявках.
*   Поддерживает фильтрацию заявок по значениям и диапазонам значений
    атрибутов.
*   Поддерживает извлечение как всех атрибутов заявок, так и заданных.
*   Поддерживает извлечение в страничном режиме с указанием смещения и
    количества заявок.

### `show`

*   Возвращает ассоциативный массив c информацией о заявке с заданным
    идентификатором записи.

### `update`

*   Осуществляет транзакцию над записями таблицы `case_attributes`, в которую
    входят следующие операции:

    -   удаление тех записей, у которых значение поля `case_id` совпадает со
        значением параметра `id` и значения поля `name` совпадают с ключами
        ассоциативного массива параметров;
    -   добавление записей, у которых значение поля `case_id` совпадает со
        значением параметра `id`, значения поля `name` совпадают с ключами
        ассоциативного массива параметров, а значения поля `value` — с
        соответствующими значениями.

*   Создаёт исключение, если в ассоциативном массиве параметров встречаются
    ключи `type` и `created_at`.

## Функции пространства имён `CaseCore::Actions::Documents`

### `create`

*   Создаёт запись документа с предоставленными атрибутами и прикрепляет её к
    записи заявки с предоставленным идентификатором.
*   Создаёт значение поля `id` записи документа с помощью генератора UUID, если
    соответствующий атрибут не был предоставлен в ассоциативном массиве
    параметров.

### `index`

*   Возвращает список ассоциативных массивов с информацией о документах,
    прикреплённых к заявке с предоставленным идентификатором записи.

### `update`

*   Обновляет запись документа с предоставленным идентификатором.

## Функции пространства имён `CaseCore::Actions::ProcessingStatuses`

### `show`

*   Возвращает ассоциативный массив с информацией о статусе обработки сообщения
    STOMP с предоставленным значением заголовка `x_message_id`.

## Функции пространства имён `CaseCore::Actions::Registers`

### `index`

*   Возвращает список ассоциативных массивов с информацией о реестрах
    передаваемой корреспонденции и количествах заявок, находящихся в них.
*   Поддерживает фильтрацию записей реестров передаваемой корреспонденции по
    значениям атрибутов.

### `show`

*   Возвращает ассоциативный массив с информацией о реестре передаваемой
    корреспонденции с предоставленным идентификатором записи, заявках,
    находящихся в нём, и количестве этих заявок.

## Функции пространства имён `CaseCore::Actions::Requests`

### `create`

*   Создаёт запись межведомственного запроса, используя текущие время и дату в
    качестве значения поля `created_at` и значение параметра `case_id` в
    качестве значения поля `case_id`.
*   Создаёт записи атрибутов межведомственного запроса, используя в качестве
    значений полей `name` и `value` все ключи и значения ассоциативного массива
    параметров, кроме ключей `id`, `case_id` и `created_at`.

### `index`

*   Возвращает список ассоциативных массивов с информацией о межведомственных
    запросах, созданных в рамках заявки с предоставленным идентификатором
    записи.

### `show`

*   Возвращает ассоциативный массив c информацией о межведомственном запросе с
    заданным идентификатором записи.

### `update`

*   Осуществляет транзакцию над записями таблицы `request_attributes`, в
    которую входят следующие операции:

    -   удаление тех записей, у которых значение поля `request_id` совпадает со
        значением параметра `id` и значения поля `name` совпадают с ключами
        ассоциативного массива параметров;
    -   добавление записей, у которых значение поля `request_id` совпадает со
        значением параметра `id`, значения поля `name` совпадают с ключами
        ассоциативного массива параметров, а значения поля `value` — с
        соответствующими значениями.

*   Создаёт исключение, если в ассоциативном массиве параметров встречаются
    ключи `case_id` и `created_at`.
