# Действия над записями

REST API и STOMP API не работают с моделями непосредственно, а используют
для работы с данными прослойку так называемых действий. Действия являются
объектами классов пространства имён `CaseCore::Actions`. Для ещё большего
упрощения работы с данными модули в пространстве имён `CaseCore::Actions`
предлагают высокоуровневые функции, которые создают действие и совершают его.

Конструктор действий предполагает, что при создании будет предоставлен
ассоциативный массив параметров. При вызове конструктора его аргумент проходит
проверку на соответствие требуемой структуре, которая задаётся в виде
JSON-схемы константой `PARAMS_SCHEMA`, определённой в пространстве имён класса
действия.

## Функции пространства имён `CaseCore::Actions::Cases`

### `call`

*   Вызывает метод модуля бизнес-логики с записью заявки в качестве аргумента.
*   Поддерживает дополнительные аргументы, если они предоставлены.

### `count`

*   Возвращает ассоциативный массив с информацией о количестве заявок.
*   Поддерживает фильтрацию заявок, а также страничный режим (см. документ о
    [механизме](./SEARCH.md) поиска записей).

### `create`

*   Создаёт запись заявки с предоставленными атрибутами и прикреплёнными
    документами, после чего возвращает созданную запись.
*   Создаёт значение поля `id` записи заявки с помощью генератора UUID, если
    соответствующий атрибут не был предоставлен в ассоциативном массиве
    параметров.
*   Игнорирует значение атрибута `created_at`, вместо этого в поле `created_at`
    записывает текущие дату и время.
*   Вызывает после создания записи заявки функцию `on_case_creation` модуля
    бизнес-логики, соответствующей типу заявки, с созданной записью заявки в
    качестве аргумента. При этом
    +   если модуль бизнес-логики не может быть найден по типу заявки, то
        создаётся исключение и транзакция создания записей отменяется;
    +   если модуль бизнес-логики не предоставляет функцию `on_case_creation`,
        то создаётся исключение и транзакция создания записей отменятся;
    +   если вызов функции `on_case_creation` приводит к созданию исключения
        класса `ArgumentError` или производного от него, то это исключение не
        блокируется, а транзакция создания записей отменяется.

### `index`

*   Возвращает список ассоциативных массивов с информацией о заявках.
*   Поддерживает фильтрацию заявок, а также страничный режим (см. документ о
    механизме поиска записей).
*   Поддерживает извлечение как всех атрибутов заявок, так и заданных.

### `show`

*   Возвращает ассоциативный массив c информацией о заявке с заданным
    идентификатором записи.

### `show_attributes`

*   Возвращает ассоциативный массив c информацией об атрибутах заявки с
    заданным идентификатором записи.

### `update`

*   Осуществляет транзакцию над записями таблицы `case_attributes`, в которую
    входят следующие операции:

    -   удаление тех записей, у которых значение поля `case_id` совпадает со
        значением параметра `id` и значения поля `name` совпадают с ключами
        ассоциативного массива параметров;
    -   добавление записей, у которых значение поля `case_id` совпадает со
        значением параметра `id`, значения поля `name` совпадают с ключами
        ассоциативного массива параметров, а значения поля `value` — с
        соответствующими значениями.

*   Поддерживает обновление атрибутов нескольких заявок. Для того чтобы
    выставить одни и те же атрибуты нескольким заявкам, необходимо предоставить
    список идентификаторов записей заявок в параметре `id`.

*   Создаёт исключение, если в ассоциативном массиве параметров встречаются
    ключи `type` и `created_at`.

*   Создаёт исключение, если запись заявки с предоставленным идентификатором
    отсутствует в базе.

## Функции пространства имён `CaseCore::Actions::Documents`

### `create`

*   Создаёт запись документа с предоставленными атрибутами и прикрепляет её к
    записи заявки с предоставленным идентификатором.
*   Создаёт значение поля `id` записи документа с помощью генератора UUID, если
    соответствующий атрибут не был предоставлен в ассоциативном массиве
    параметров.

### `index`

*   Возвращает список ассоциативных массивов с информацией о документах,
    прикреплённых к заявке с предоставленным идентификатором записи.

### `update`

*   Обновляет запись документа с предоставленным идентификатором.

## Функции пространства имён `CaseCore::Actions::ProcessingStatuses`

### `show`

*   Возвращает ассоциативный массив с информацией о статусе обработки сообщения
    STOMP с предоставленным значением заголовка `x_message_id`.

## Функции пространства имён `CaseCore::Actions::Requests`

### `count`

*   Возвращает ассоциативный массив с информацией о количестве межведомственных
    запросов, созданных в рамках заявки.
*   Поддерживает фильтрацию межведомственных запросов, а также страничный режим
    (см. документ о [механизме](./SEARCH.md) поиска записей).

### `create`

*   Создаёт запись межведомственного запроса, используя текущие время и дату в
    качестве значения поля `created_at` и значение параметра `case_id` в
    качестве значения поля `case_id`.
*   Создаёт записи атрибутов межведомственного запроса, используя в качестве
    значений полей `name` и `value` все ключи и значения ассоциативного массива
    параметров, кроме ключей `id`, `case_id` и `created_at`.

### `find`

*   Ищет запись межведомственного запроса по названиям и значениям атрибутов и
    возвращает её в случае успеха или `nil`, если запись невозможно найти.

### `index`

*   Возвращает список ассоциативных массивов с информацией о межведомственных
    запросах, созданных в рамках заявки с предоставленным идентификатором
    записи.

### `show`

*   Возвращает ассоциативный массив c информацией о межведомственном запросе с
    заданным идентификатором записи.

### `update`

*   Осуществляет транзакцию над записями таблицы `request_attributes`, в
    которую входят следующие операции:

    -   удаление тех записей, у которых значение поля `request_id` совпадает со
        значением параметра `id` и значения поля `name` совпадают с ключами
        ассоциативного массива параметров;
    -   добавление записей, у которых значение поля `request_id` совпадает со
        значением параметра `id`, значения поля `name` совпадают с ключами
        ассоциативного массива параметров, а значения поля `value` — с
        соответствующими значениями.

*   Создаёт исключение, если в ассоциативном массиве параметров встречаются
    ключи `case_id` и `created_at`.
