# Модели и записи

## Основные сведения

*   В приложении используются реляционные модели данных.

*   В качестве СУБД выступает PostgreSQL.

*   В качестве ORM выступает библиотека `sequel`.

*   Создание таблиц представлено в виде так называемых миграций, описания
    которых находятся в директории `db/migrations`.

*   Описания моделей находится в директории `lib/case_core/models`.

*   Модели описаны в виде классов-наследников класса `Sequel::Model`,
    располагаются в пространстве имён `CaseCore::Models` и предоставляют
    свойства, чьи названия копируют названия полей соответствующих таблиц.

## Основные модели

### Модель данных заявки

*   Основана на таблице `cases` (таблица основных атрибутов) и таблице
    `case_attributes` (таблица дополнительных атрибутов).

*   Описана с помощью классов `CaseCore::Models::Case` и
    `CaseCore::Models::CaseAttribute`.

#### Поля таблицы `cases`

*   `id` типа `text`:

    -   является первичным ключом.

*   `type` типа `text`:

    -   значение интерпретируется в качестве названия библиотеки с модулем
        бизнес-логики, обрабатывающей заявку;
    -   является индексируемым;
    -   не может принимать значение `NULL`.

*   `created_at` типа `timestamp`:

    -   интерпретируется в качестве даты и времени создания записи;
    -   является индексируемым;
    -   не может принимать значение `NULL`.

#### Поля таблицы `case_attributes`

*   `case_id` типа `text`:

    -   является внешним ключом, который ссылается на поле `id` таблицы
        `cases`;
    -   значение поля интерпретируется в качестве идентификатора записи заявки,
        которой принадлежит дополнительный атрибут;
    -   не может принимать значения `NULL`.

*   `name` типа `text`:

    -   значение интерпретируется в качестве названия атрибута;
    -   является индексируемым;
    -   не может принимать значение `NULL`;
    -   не может принимать значения `type` и `created_at`.

*   `value` типа `text`:

    -   значение интерпретируется в качестве значения атрибута;
    -   является индексируемым.

*   Первичным ключом таблицы является композитный индекс, созданный на основе
    полей `case_id` и `name`.

### Модель данных межведомственного запроса

*   Основана на таблице `requests` (таблица основных атрибутов) и
    `request_attributes` (таблица дополнительных атрибутов).

*   Описана с помощью классов `CaseCore::Models::Request` и
    `CaseCore::Models::RequestAttribute`.

#### Поля таблицы `requests`

*   `id` типа `integer`:

    -   является первичным ключом.

*   `created_at` типа `timestamp`:

    -   значение интерпретируется в качестве даты и времени создания записи;
    -   является индексируемым;
    -   не может принимать значение `NULL`.

*   `case_id` типа `text`:

    -   является внешним ключом, который ссылается на поле `id` таблицы
        `cases`;
    -   значение поля интерпретируется в качестве идентификатора записи заявки,
        в рамках которой создан межведомственный запрос;
    -   не может принимать значения `NULL`.

#### Поля таблицы `request_attributes`

*   `request_id` типа `text`:

    -   является внешним ключом, который ссылается на поле `id` таблицы
        `requests`;
    -   значение поля интерпретируется в качестве идентификатора записи
        межведомственного запроса, которому принадлежит дополнительный атрибут;
    -   не может принимать значения `NULL`.

*   `name` типа `text`:

    -   значение интерпретируется в качестве названия атрибута;
    -   является индексируемым;
    -   не может принимать значение `NULL`;
    -   не может принимать значение `created_at`.

*   `value` типа `text`:

    -   значение поля интерпретируется в качестве значения атрибута;
    -   поле является индексируемым.

*   Первичным ключом таблицы является композитный индекс, созданный на основе
    полей `request_id` и `name`.

### Модель данных файла

*   Основана на таблице `files`.

*   Описана с помощью класса `CaseCore::Models::File`.

#### Поля таблицы `files`

*   `id` типа `uuid`:

    -   является первичным ключом.

*   `content` типа `bytea`:

    -   значение интерпретируется в качестве содержимого файла;
    -   не может принимать значение `NULL`.

*   `created_at` типа `timestamp`:

    -   значение интерпретируется в качестве даты и времени создания записи;
    -   является индексируемым;
    -   не может принимать значение `NULL`.

### Модель данных документа, прикреплённого к заявке

*   Основана на таблице `documents`.

*   Описана с помощью класса `CaseCore::Models::Document`.

*   Построена во многом по аналогии с моделью данных документа в сервисе
    `case_manager`.

#### Поля таблицы `documents`

*   `id` типа `text`:

    -   является первичным ключом.

*   `case_id` типа `text`:

    -   является внешним ключом, который ссылается на поле `id` таблицы
        `cases`;
    -   значение поля интерпретируется в качестве идентификатора записи заявки,
        к которой прикреплён документ;
    -   не может принимать значения `NULL`.

*   `title` типа `text`:

    -   значение поля интерпретируется в качестве заголовка документа.

*   `direction` перечислимого типа со значениями `input` и `output`:

    -   значение `input` интерпретируется в том смысле, что документ является
        необходимым для получения результата;
    -   значение `output` интерпретируется в том смысле, что документ является
        результатом оказания услуги.

*   `correct` типа `boolean`:

    -   значение поля интерпретируется в том смысле, правильно ли составлен
        документ.

*   `provided_as` перечислимого типа со значениями `original`, `copy`,
    `notarized_copy`, `doc_list`:

    -   значение поля интерпретируется в качестве вида документа
        (соответственно, оригинал, ксерокопия, нотариальная копия, расписка).

*   `size` типа `text`:

    -   значение поля интерпретируется в качестве размера файла электронной
        копии документа.

*   `last_modified` типа `text`:

    -   значение поля интерпретируется в качестве времени и даты последнего
        обновления электронной копии документа.

*   `quantity` типа `integer`:

    -   значение поля интерпретируется в качестве количества листов в
        документе.

*   `mime_type` типа `text`:

    -   значение поля интерпретируется в качестве MIME-типа документа.

*   `filename` типа `text`:

    -   значение поля интерпретируется в качестве названия файла электронной
        копии документа.

*   `provided` типа `boolean`:

    -   значение поля интерпретируется в том смысле, предоставлен ли документ
        или нет.

*   `in_document_id` типа `text`:

    -   значение поля интерпретируется в качестве внутреннего идентификатора
        документа.

*   `fs_id` типа `text`:

    -   является внешним ключом, который ссылается на поле `id` таблицы
        `files`;
    -   значение поля интерпретируется в качестве идентификатора записи файла,
        к которой прикреплён документ.

*   `created_at` типа `timestamp`:

    -   значение поля интерпретируется в качестве даты и времени создания
        электронной копии документа.

## Служебные модели

### Модель статуса обработки сообщения STOMP

*   Используется для хранения информации о том, было ли успешно обработно
    сообщение STOMP и какие ошибки возникли в процессе обработки.

*   Основана на таблице `processing_statuses`.

*   Описана с помощью класса `CaseCore::Models::ProcessingStatus`.

#### Поля таблицы `processing_statuses`

*   `id` типа `integer`:

    -   является первичным ключом.

*   `message_id` типа `text`:

    -   значение интерпретируется в качестве значения заголовка `x_message_id`
        обрабатываемого сообщения STOMP;
    -   значения не могут повторяться;
    -   является индексируемым.

*   `status` перечислимого типа со значениями `ok` и `error`:

    -   значение `ok` означает, что во время обработки сообщения STOMP не
        возникло ошибок;
    -   значение поля `error` означается, что во время обработки сообщения
        STOMP возникла ошибка;
    -   не может принимать значение `NULL`.

*   `headers` типа `jsonb`:

    -   значение интерпретируется как ассоциативный массив заголовков сообщения
        STOMP;
    -   не может принимать значение `NULL`.

*   `error_class` типа `text`:

    -   если значение поля не равно `NULL`, то оно интерпретируется как полное
        название класса ошибки, возникшей во время обработки сообщения STOMP
    -   значение поля, равное `NULL`, означает, что во время обработки
        сообщения STOMP ошибки не произошло.

*   `error_text` типа `text`:

    -   если значение поля равно `NULL`, то оно интерпретируется как сообщение
        об ошибке, возникшей во время обработки сообщения STOMP;
    -   значение поля, равное `NULL`, означает, что во время обработки
        сообщения STOMP ошибки не произошло.

## Задание первичных ключей

*   Задание значения первичного ключа типа `integer` в ассоциативном массиве
    атрибутов записи при вызове функции `create` модели приводит к созданию
    исключения `Sequel::MassAssignmentRestriction`. В подавляющем большинстве
    случаев в задании значений этих первичных ключей нет необходимости, так как
    PostgreSQL использует для них автоматические генераторы.

*   Задание значения первичного ключа типа `text` является необходимым при
    непосредственном использовании функции `create`.
