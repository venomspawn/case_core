# Создание бизнес-логики заявки на примере заявки на МСП-услугу

В этом документе описываются этапы написания библиотеки с модулем бизнес-логики
заявки на МСП-услугу с помощью готовых инструментов, а также приводятся
вспомогательные сведения.

## Краткое описание сервиса `case_core`

Сервис `case_core` — это сервис управления заявками на услуги, который
позволяет создавать и обновлять записи заявок и иных сущностей, ассоциированных
с заявками. Одной из главных особенностей сервиса является выделение
бизнес-логики, обрабатывающей заявку, в библиотеки и динамическая загрузка этих
библиотек, что позволяет осуществлять их обновление «на лету». Сервис
предоставляет бизнес-логике API для отправки сообщений в очереди СМЭВ, API для
REST-запросов ко внешним ресурсам, а также иные вспомогательные инструменты.

## Жизненный цикл заявки на МСП-услугу

Рассмотрим жизненный цикл заявки на МСП-услугу в виде следующего графа, который
в дальнейшем будет называться графом перехода состояний заявки:

```
   +-+   A   +------------+   B1  +-------+
   | |------>| processing |------>| error |
   +-+       +------------+       +-------+
                |      |
                | B2   | B3
                |      V
                |   +----------+
                |   | issuance |
                |   +----------+
                |      |
                |      | C
                V      V
               +--------+
               | closed |
               +--------+
```

В вершинах графа отмечены состояния и отсутствие состояния, а над дугами —
соответствующие события. Состояния интерпретируются следующим образом:
*   `processing` — обработка заявки;
*   `issuance` — выдача результата заявки;
*   `error` — при обработке заявки произошла ошибка;
*   `closed` — заявка закрыта.

События означают следующее.
*   `A` — создание записи заявки. После перехода по дуге необходимо отправить
    сообщение с межведомственным запросом в СМЭВ.
*   `B1` — пришёл ответ от СМЭВ, сигнализирующий об ошибке.
*   `B2` — пришёл положительный ответ от СМЭВ, при этом результат оказания
    услуги необходимо направить по адресу электронной почты заявителя. При
    переходе по дуге необходимо отметить дату и время выставления нового
    состояния заявки.
*   `B3` — пришёл положительный ответ от СМЭВ, при этом результат оказания
    услуги необходимо выдать заявителю.
*   `C` — результат оказания услуги выдан заявителю. При переходе по дуге
    необходимо отметить дату и время выставления нового состояния заявки.

В такой трактовке жизненного цикла заявки на МСП-услугу бизнес-логика должна
предоставлять обработчики событий, которые
*   проверяют выполнение условий на переход по дуге, если такие указаны;
*   выставляют значения атрибутов заявки;
*   выполняют действия после перехода (например, отправляют сообщение в СМЭВ).

## Пользовательские и системные события

Основным интерфейсом бизнес-логики для получения информации о событиях являются
функции модуля бизнес-логики. Сервис использует следующие функции модуля, если
они предоставлены:
*   `on_load` — загрузка модуля;
*   `on_unload` — выгрузка модуля;
*   `on_case_creation` — создание записи заявки;
*   `on_responding_stomp_message` — входящее сообщение STOMP.
Кроме того, модуль может предоставлять дополнительные функции, которые могут
вызываться через механизм удалённого вызова (RPC). Так, например, обработку
события `C` в жизненном цикле заявки на МСП-услугу можно осуществить с помощью
дополнительной функции. Для этого её необходимо вызывать из приложения, в
котором работает оператор, выдающий результат оказания услуги.

## Начало создания библиотеки

Для библиотеки понадобится отдельный проект `msp_case` в Gitlab и базовая
инфраструктура для развёртывания виртуальной машины, запуска тестов и сборки
библиотеки с бизнес-логикой. Расположим модуль бизнес-логики в файле
`lib/msp_case.rb` и определим в нём следующие функции:
```ruby
module MSPCase
  def self.change_state_to(c4s3, state, params)
  end

  def self.on_case_creation(c4s3)
  end

  def self.on_responding_stomp_message(message)
    false
  end
end
```

Реализация функций может разниться от библиотеки к библиотеке. Вообще говоря,
сервис не накладывает никаких ограничений на реализацию за исключением того,
что библиотека не может использовать посторонние решения, кроме тех, что
прописаны в сервисе (`activesupport`, `rufus-scheduler` и некоторые другие).
Отметим, что эти функции полностью покрывают жизненный цикл заявки на
МСП-услугу.

## Обработка событий ручного изменения состояния

В жизненном цикле заявки можно выделить события, созданные в результате ручного
действия человека, например, нажатие на кнопку «Создать заявку» приводит к
вызову функции `on_case_creation` или нажатие на кнопку «Закрыть» приводит к
вызову функции `change_state_to` с соответствующим аргументом (при должной
реализации). К этой категории относятся события `A` и `C` графа переходов
состояния заявки на МСП-услугу. Для их описания портируем движок обработчика
подобных событий из класса `MFCCase::Base::StateDrivenFSA` в класс
`MSPCase::Base::StateDrivenFSA`. Этот движок предлагает язык для описания
переходов и действий, связанных с ними, при этом его возможности шире, чем
необходимые нам. Вообще говоря, при портировании мы можем урезать возможности
движка, убрав поддержку конструкций `check` и `raise`. После портирования можно
использовать движок, создав описания переходов в файле
`lib/msp_case/change_state_to.rb`:
```ruby
load "#{__dir__}/base/state_driven_fsa.rb"

module MSPCase
  class ChangeStateTo < Base::StateDrivenFSA
    load "#{__dir__}/change_state_to/create_request.rb"

    # A
    edge nil:   :processing,
         need:  %w(special_data service_id),
         after: CreateRequest

    # C
    edge issuance: :closed,
         set:      { closed_at: :now }
  end
end
```
Первый аргумент конструкции `edge` описывает, из какого состояния в какое идёт
дуга. Значение `nil` указывает на отсутствие состояния. Далее, эта конструкция
поддерживает следующие параметры:
*   `need` — атрибуты, которые необходимо извлечь перед обработкой перехода;
*   `after` — операция, которую необходимо осуществить после обновления
    атрибутов заявки;
*   `set` — ассоциативный массив с информацией о новых значениях атрибутов.

В файле `lib/msp_case/change_state_to/create_request.rb` необходимо создать
модуль `MSPCase::ChangeStateTo::CreateRequest`, предоставляющий функцию `call`,
которая принимает запись заявки и ассоциативный массив её аргументов в качестве
аргументов:
```ruby
require 'securerandom'

module MSPCase
  class ChangeStateTo
    module CreateRequest
      def self.call(c4s3, case_attributes)
        message_id = SecureRandom.uuid
        request = CaseCore::Actions::Requests
                  .create(case_id: c4s3.id, msp_message_id: message_id)
        publish_message(case_attributes, message_id)
      end

      QUEUE_NAME = 'smev3.queue'

      def self.publish_message(case_attributes, message_id)
        message = message_data(case_attributes, message_id).to_json
        CaseCore::API::STOMP::Controller.publish(QUEUE_NAME, message, {})
      end

      def self.message_data(case_attributes, message_id)
        {
          id:      message_id,
          content: case_attributes.slice(:special_data, :service_id)
        }
      end
    end
  end
end
```

Теперь можно добавить реализацию обработчиков событий:
```ruby
load "#{__dir__}/msp_case/change_state_to.rb"

module MSPCase
  def self.change_state_to(c4s3, state, params)
    ChangeStateTo.new(c4s3, state, params).process
  end

  def self.on_case_creation(c4s3)
    ChangeStateTo.new(c4s3, 'processing', {}).process
  end

  def self.on_responding_stomp_message(message)
    false
  end
end
```

## Обработка сообщений СМЭВ

Кроме ручного изменения состояния заявки можно также выделить изменение
состояния заявки при обработке сообщений СМЭВ. Так, к событиям, связанными с
сообщениями СМЭВ, можно отнести события `B1`, `B2`, `B3` графа переходов
состояния заявки на МСП-услугу. Для описания переходов можно портировать движок
обработчика событий ручного изменения состояния заявки. Можно выделить
следующие отличия, требующие проработки при портировании.
1.  Сообщения СМЭВ несут информацию о том, произошла ли ошибка при запросе, был
    ли запрос принят или отклонён. Поэтому необходим параметр, значение
    которого указывает на формат обрабатываемого сообщения СМЭВ для данной
    дуги.
2.  Необходимо учесть условие на дугу с помощью некоторого параметра.

Портирование движка выходит за рамки этого документа (пример готовой
реализации можно найти в том же проекте `msp_case`), потому приведём только
готовое описание переходов:
```ruby
load "#{__dir__}/base/message_driven_fsa.rb"

module MSPCase
  class RespondToMessage < Base::MessageDrivenFSA
    # B1
    edge processing: :error,
         on:         :exception

    # B2
    edge processing: :closed,
         on:         %w(rejection response),
         if:         -> { issue_location_type == 'email' },
         need:       %w(issue_location_type),
         set:        { closed_at: :now }

    # B3
    edge processing: :issuance,
         on:         %w(rejection response),
         if:         -> { issue_location_type == 'mfc' },
         need:       %w(issue_location_type)
  end
end
```

Результирующее описание обработчиков переходов может выглядеть следующим
образом:
```ruby
require 'active_support/core_ext/hash/slice.rb'
require 'active_support/core_ext/object/blank.rb'
require 'active_support/core_ext/string/filters.rb'
require 'json'
require 'json-schema'

load "#{__dir__}/msp_case/change_state_to.rb"
load "#{__dir__}/msp_case/respond_to_message.rb"

module MSPCase
  def self.change_state_to(c4s3, state, params)
    ChangeStateTo.new(c4s3, state, params).process
  end

  def self.on_case_creation(c4s3)
    ChangeStateTo.new(c4s3, 'processing', {}).process
  end

  def self.on_responding_stomp_message(message)
    RespondToMessage.new(message).process
    true
  rescue
    false
  end
end
```
